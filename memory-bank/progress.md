# 项目进展

## 已完成功能

- **项目脚手架**: 基础的 Next.js 项目结构已经建立。
- **API 转换层**: 已经实现了 OpenAI 到 Gemini, Anthropic 到 Gemini 以及 Gemini 到 Anthropic 的核心适配器逻辑。
- **管理界面**: 实现了基本的登录、API 密钥管理和日志查看功能。
- **数据库**: 数据库模式已经定义，并且包含了用于存储密钥和日志的表。
- **记忆库**: 核心文档已经初始化。
- **智能模型映射 (核心)**:
  - **描述**: 实现了由数据库驱动的动态模型路由。API 路由现在通过 `ModelMappingService` 来决定下游目标，取代了硬编码逻辑。
  - **状态**: 后端逻辑与 API 集成已完成。前端提供了只读的查看页面。
- **模型映射管理 (CRUD)**:
  - **描述**: 在管理界面中实现了对模型映射规则的完整创建、更新和删除功能。
  - **状态**: 功能完成，包括后端服务、Server Actions 和统一的表单对话框 UI。
- **单元测试覆盖**:
  - **描述**: 为 `lib/services` 和 `lib/adapters` 中新增和之前未覆盖的代码添加了单元测试。
  - **状态**: `ModelMappingService`, `gemini-to-gemini`, 和 `gemini-to-openai` 已覆盖。
- **数据库驱动的路由逻辑重构**:
  - **描述**: 将 `model_mappings` 表中的 `target_endpoint` 字段重构为 `target_method`，并更新了 UI 和 API 路由以使用此新配置来决定流式/非流式行为。同时，增强了对 `__DEFAULT__` 规则的保护，禁止了对其的删除和名称修改。
  - **状态**: 功能完成。
- **增强的日志和分析**:
  - **描述**: 在管理仪表盘中添加了详细的 API 调用统计和分析图表。通过引入 `recharts` 库，实现了按天、按模型聚合的数据可视化。
  - **状态**: 功能完成。
- **Google GenAI SDK 迁移**:
  - **描述**: 根据 `docs/MIGRATION_PLAN_TO_GENAI.md` 中的计划，执行了从 `@google/generative-ai` 到 `@google/genai` 的迁移。
  - **状态**: **已完成 (包括后续修复)**。修复了因迁移不完全导致的多个编译错误和 504 运行时超时错误。
- **单元测试修复**:
  - **描述**: 修复了 `anthropic-to-gemini` 适配器中因参数不匹配和实现不完整而导致的测试失败。
  - **状态**: 功能完成。所有单元测试均已通过。
- **可配置的重试策略**:
  - **描述**: 将硬编码的 API 重试参数（延迟和时间窗口）重构为可通过管理界面动态配置的系统设置。
  - **状态**: 功能完成。包括后端服务、前端 UI 和国际化文本的更新。

## 待办事项

- **端到端测试 (E2E)**:
  - **描述**: 为核心用户流程（如模型路由）编写端到端测试。

## 已知问题

- **流式响应处理**: 在某些边缘情况下，从 Gemini 到 OpenAI 的流式响应转换可能存在延迟或格式问题。
- **错误处理**: 需要改进 API 层对下游模型错误的传递和格式化。
- **Punycode 弃用警告**: 在运行测试时，Node.js 会显示关于 `punycode` 模块的弃用警告。尽管已尝试通过直接依赖和 pnpm `overrides` 来解决，但该警告仍然存在。此警告为非关键性问题。

## 项目决策演变

- **最初**: 项目最初只关注 OpenAI 到 Gemini 的转换。
- **当前**: 范围已扩大，以支持多个源和目标 API，使其成为一个更通用的网关。
