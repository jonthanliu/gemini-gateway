# 系统模式

## 架构概述

`gemini-gateway` 采用基于 Next.js 的全栈架构，分为两个主要部分：

1.  **API 网关 (`/app/(api)`)**：处理所有传入的 AI 请求。这是系统的核心，负责认证、路由、请求/响应转换和日志记录。
2.  **管理界面 (`/app/(web)`)**：一个受密码保护的 Web 应用程序，允许管理员配置网关、管理 API 密钥和查看日志。

这种分离的结构使得 API 的高性能需求和管理界面的复杂交互可以独立开发和扩展。

## 关键设计模式

1.  **适配器模式**：

    - **位置**：`lib/adapters/`
    - **描述**：这是实现 API 转换的核心。为每个（源 API -> 目标 API）的组合创建一个适配器（例如 `openai-to-gemini.ts`）。每个适配器负责将请求格式从源转换为目标，并将响应格式从目标转换回源。
    - **优点**：将转换逻辑封装起来，使得添加对新模型或新 API 格式的支持变得简单，只需添加新的适配器即可。

2.  **中间件模式**：

    - **位置**：`middleware.ts`
    - **描述**：用于处理国际化（i18n）路由和可能的全局请求预处理。
    - **优点**：在请求到达 API 路由处理程序之前，集中处理跨领域的关注点。

3.  **服务层模式**：

    - **位置**：`lib/services/`
    - **描述**：将核心业务逻辑（如数据库操作）从 API 路由处理程序中分离出来。例如，`key.service.ts` 封装了所有与 API 密钥相关的数据库交互。
    - **优点**：提高了代码的可重用性和可测试性，并使 API 路由处理程序更简洁，只关注请求和响应的协调。

4.  **环境变量配置**：

    - **位置**：`.env.example`, `lib/config/envConfig.ts`
    - **描述**：通过环境变量来管理所有敏感信息和环境特定的配置。`envConfig.ts` 提供类型安全的访问方式。
    - **优点**：安全地管理配置，避免将敏感数据硬编码到代码中，并方便在不同环境（开发、生产）中部署。

5.  **数据库驱动的配置模式**：

    - **位置**：`app/(api)/**/route.ts`, `lib/services/model-mapping.service.ts`
    - **描述**：系统的核心行为，例如一个请求应该是流式还是单元响应，是由数据库中的 `model_mappings` 表驱动的。API 路由查询服务层 (`modelMappingService`)，该服务层根据数据库中的规则来决定正确的行为。
    - **优点**：极大地提高了系统的灵活性和动态性。管理员可以通过管理界面实时更改 API 行为，而无需重新部署代码。

6.  **混合组件模式 (服务器 + 客户端)**：
    - **位置**：`app/(web)/[lang]/admin/components/Dashboard.tsx` (服务器), `AnalyticsDashboard.tsx` (客户端)
    - **描述**：在构建复杂 UI 时，采用一种混合方法。父组件 (`Dashboard.tsx`) 是一个异步服务器组件，负责在服务器端获取初始数据（如密钥列表、系统概览统计）。它将这些数据传递给子组件。需要交互性和动态数据获取的子组件 (`AnalyticsDashboard.tsx`) 则被定义为客户端组件 (`"use client"`)。这个客户端组件负责处理用户交互（如日期选择，虽然尚未实现但已为此设计）和通过 `useEffect` 异步获取更多数据（如分析图表数据）。
    - **优点**：这种模式充分利用了 Next.js App Router 的优势。它通过在服务器上尽可能多地完成工作来优化初始页面加载性能，同时保留了在客户端实现丰富、动态交互的能力。
