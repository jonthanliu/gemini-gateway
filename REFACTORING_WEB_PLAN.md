# WebApp 重构计划与进度

本文档旨在追踪 Gemini Gateway WebApp 重构过程中的进度与架构决策。

## 第一阶段：奠定基础架构 (已完成)

本初始阶段的核心目标是为重构后的前端应用建立一个全新的、健壮的、且与旧代码完全隔离的开发环境。

### 1. 隔离旧代码
- **操作**: 将旧的路由组 `app/(webapp)` 重命名为 `app/(webapp)_deprecated`。
- **目的**: 此操作安全地停用了所有旧路由，避免了 URL 冲突，同时完整地保留了旧代码库，以供参考和渐进式迁移。

### 2. 建立新的 `(web)` 路由组
- **操作**: 创建了一个全新的、平行的路由组 `app/(web)`。
- **目的**: 为新的前端架构提供了一个干净、隔离的工作空间，确保不受旧实现的影响。

### 3. 分离 WebApp 认证逻辑
- **操作**: 创建了新文件 `lib/auth/web_auth.ts`，用于存放 WebApp 专属的认证逻辑。现有的 `lib/auth/auth.ts` 将只负责 API 认证。
- **目的**: 此举将两个关键的认证体系（WebApp 会话 与 API 令牌）解耦，使它们可以独立演进，避免潜在的副作用。

### 4. 构建新的 `admin` 架构
- **操作**: 在 `app/(web)/[lang]/admin` 下创建了新的、更有组织的目录结构，包括专用的 `actions` 和 `components` 子目录。
- **目的**: 与旧代码的扁平化布局相比，这种模块化的结构更具可扩展性和可维护性。

### 5. 实现服务端认证守卫
- **操作**: 为 `admin` 路由创建了一个新的 `layout.tsx`。
- **功能**: 这是一个**服务器组件**，充当了整个管理后台的中央安全门。它在渲染任何 UI 之前，**在服务器端**使用 `checkAuthState` 辅助函数验证用户登录状态。根据验证结果，它会条件性地渲染仪表盘的主布局（如包含页眉），或直接将未授权用户传递给页面（此时页面将渲染登录表单）。

### 6. 实现条件化页面渲染
- **操作**: 为 `admin` 路由创建了一个新的 `page.tsx`。
- **功能**: 这是一个**服务器组件**，充当了逻辑路由器的角色。它获取用户的认证状态和应用的状态（即是否已存在 API 密钥），然后根据这些信息渲染三个组件之一：
  1.  `LoginForm` (如果未登录)
  2.  `Onboarding` (如果已登录但无密钥)
  3.  `Dashboard` (如果已登录且有密钥)
- **目的**: 这种以服务器为中心的方法非常高效和安全，它避免了页面内容闪烁，并确保从首次渲染开始就向客户端提供正确的 UI。

### 7. 搭建新登录流程骨架
- **操作**: 创建了新的 `LoginForm` 客户端组件及其对应的 `login` Server Action 的骨架。
- **功能**: 这确立了使用 `useActionState` 和 `useFormStatus` 的现代化表单处理模式，无需传统的 API 端点，即可直接将客户端表单连接到服务端逻辑，提供了响应灵敏且友好的用户体验。

---

至此，基础架构搭建工作已全部完成。新架构现已准备就绪，可以开始进行功能迁移。
